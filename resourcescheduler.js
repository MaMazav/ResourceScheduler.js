var n=function(){function b(d,l){this.K=d;this.g=this.u=l;this.o=Array(this.u);this.J=[]}b.prototype={M:function(d,l){if(0<this.g){--this.g;var b=this.o.pop();void 0===b&&(b=this.K());d(b,l)}else this.J.push({H:d,c:l})},N:function(d){if(0<this.J.length){var b=this.J.pop();b.H(d,b.c)}else this.o.push(d),++this.g},O:function(){return!1},P:function(){return!1}};return b}();var p=function(){function b(){this.D={h:null,F:this};this.v={m:null,F:this};this.l=0;this.v.h=this.D;this.D.m=this.v}b.prototype.add=function(d,b){if(null===b||void 0===b)b=this.v;this.w(b);++this.l;var h={U:d,m:b,h:b.h,F:this};h.h.m=h;return b.h=h};b.prototype.remove=function(d){this.w(d);--this.l;d.h.m=d.m;d.m.h=d.h;d.F=null};b.prototype.G=function(d){this.w(d);return d.U};b.prototype.A=function(){return this.B(this.D)};b.prototype.V=function(){return this.W(this.v)};b.prototype.B=function(d){this.w(d);
return d.m===this.v?null:d.m};b.prototype.W=function(d){this.w(d);return d.h===this.D?null:d.h};b.prototype.w=function(d){if(d.F!==this)throw"iterator must be of the current LinkedList";};return b}();var u=function(){function b(a,e,f,c){c=c||{};this.K=a;this.u=e;this.j=f;this.f=c.showLog;this.R=c.schedulerName;this.I=c.numNewJobs||20;this.S=c.numJobsBeforeRerankOldPriorities||20;this.g=this.u;this.o=Array(this.u);this.T=c.resourcesGuaranteedForHighPriority||0;this.s=">";this.i=0;this.b=[];this.a=new p;this.L=0}function d(a,e){c(a,"tryDequeueNewJobWithHigherPriority() start",1);for(var f=null,k=e,d=[],g=a.a.A();null!==g;){var b=a.a.B(g),l=a.a.G(g),h=a.j.getPriority(l.c);if(0>h)q(a,g),--a.i,l.C(l.c);
else{if(void 0===k||h>k)k=h,f=g;a.f&&(void 0===d[h]?d[h]=1:++d[h])}g=b}g=null;null!==f&&(g=q(a,f),--a.i);if(a.f){f="tryDequeueNewJobWithHigherPriority(): Jobs list:";for(b=0;b<d.length;++b)void 0!==d[b]&&(f+=d[b]+" jobs of priority "+b+";");c(a,f);null!==g&&c(a,"tryDequeueNewJobWithHigherPriority(): dequeued new job of priority "+k)}m(a);c(a,"tryDequeueNewJobWithHigherPriority() end",-1);return g}function l(a,e,f){c(a,"enqueueNewJob() start",1);++a.i;var k=a.a.A();r(a,e,k);a.f&&c(a,"enqueueNewJob(): enqueued job of priority "+
f);a.a.l<=a.I?(m(a),c(a,"enqueueNewJob() end: _newPendingJobsLinkedList is small enough",-1)):(e=a.a.V(),e=q(a,e),h(a,e),m(a),c(a,"enqueueNewJob() end: One job moved from new job list to old job list",-1))}function h(a,e){c(a,"enqueueOldJob() start",1);var f=a.j.getPriority(e.c);0>f?(--a.i,e.C(e.c),c(a,"enqueueOldJob() end: job aborted",-1)):(void 0===a.b[f]&&(a.b[f]=[]),a.b[f].push(e),c(a,"enqueueOldJob() end: job enqueued to old job list",-1))}function v(a,e){c(a,"resourceFreed() start",1);++a.g;
var f=w(a);--a.g;f=d(a,f);if(null!==f)m(a),t(a,f,e),m(a),c(a,"resourceFreed() end: new job scheduled",-1);else if(a.i>a.a.l){for(var k,b=a.b.length-1;0<=b;--b){var g=a.b[b];if(void 0!==g&&0!==g.length){for(var h=g.length-1;0<=h;--h){f=g[h];k=a.j.getPriority(f.c);if(k>=b){g.length=h;break}else 0>k?(--a.i,f.C(f.c)):(void 0===a.b[k]&&(a.b[k]=[]),a.b[k].push(f));f=null}if(null!==f)break;g.length=0}}null===f?(a.o.push(e),++a.g,m(a),c(a,"resourceFreed() end: no non-aborted job to schedule",-1)):(a.f&&c(a,
"resourceFreed(): dequeued old job of priority "+k),--a.i,m(a),t(a,f,e),m(a),c(a,"resourceFreed() end: job scheduled",-1))}else a.o.push(e),++a.g,m(a),c(a,"resourceFreed() end: no job to schedule",-1)}function t(a,e,f){c(a,"schedule() start",1);++a.L;if(a.L>=a.S){a.L=0;c(a,"rerankPriorities() start",1);var b=a.b,d=a.a;if(0===b.length)c(a,"rerankPriorities() end: no need to rerank",-1);else{a.b=[];a.a=new p;for(var g=0;g<b.length;++g)if(void 0!==b[g])for(var l=0;l<b[g].length;++l)h(a,b[g][l]);for(g=
d.A();null!==g;)b=d.G(g),h(a,b),g=d.B(g);d="rerankPriorities(): ";for(g=a.b.length-1;0<=g;--g)if(b=a.b[g],void 0!==b){for(a.f&&(d+=b.length+" jobs in priority "+g+";");0<b.length&&a.a.l<a.I;)l=b.pop(),r(a,l);if(a.a.l>=a.I&&!a.f)break}a.f&&c(a,d);m(a);c(a,"rerankPriorities() end: rerank done",-1)}}a.f&&(g=a.j.getPriority(e.c),c(a,"schedule(): scheduled job of priority "+g));e.H(f,e.c);c(a,"schedule() end",-1)}function r(a,e,f){c(a,"addJobToLinkedList() start",1);a.a.add(e,f);x(a);c(a,"addJobToLinkedList() end",
-1)}function q(a,e){c(a,"extractJobFromLinkedList() start",1);var f=a.a.G(e);a.a.remove(e);x(a);c(a,"extractJobFromLinkedList() end",-1);return f}function x(a){if(a.f){c(a,"ensureNumberOfNodes() start",1);for(var e=a.a.A(),f=0;null!==e;)++f,e=a.a.B(e);if(f!==a.a.l)throw"Unexpected count of new jobs";c(a,"ensureNumberOfNodes() end",-1)}}function m(a){if(a.f){c(a,"ensurePendingJobsCount() start",1);for(var e=0,f=0;f<a.b.length;++f){var b=a.b[f];void 0!==b&&(e+=b.length)}if(e+a.a.l!==a.i)throw"Unexpected count of jobs";
c(a,"ensurePendingJobsCount() end",-1)}}function w(a){c(a,"getMinimalPriorityToSchedule() start",1);if(a.g<=a.T)return c(a,"getMinimalPriorityToSchedule() end: guarantee resource for high priority is needed",-1),a.X;c(a,"getMinimalPriorityToSchedule() end: enough resources, no need to guarantee resource for high priority",-1);return 0}function c(a,e,c){a.f&&(-1===c&&(a.s=a.s.substr(1)),void 0!==a.R?console.log(a.s+"PriorityScheduler "+a.R+": "+e):console.log(a.s+"PriorityScheduler: "+e),1===c&&(a.s+=
">"))}b.prototype={M:function(a,e,b){c(this,"enqueueJob() start",1);var d=this.j.getPriority(e);0>d?(b(e),c(this,"enqueueJob() end: job aborted",-1)):(a={H:a,C:b,c:e},e=w(this),b=null,d>=e&&(c(this,"tryGetFreeResource() start",1),0===this.g?b=null:(--this.g,e=this.o.pop(),void 0===e&&(e=this.K()),m(this),c(this,"tryGetFreeResource() end",-1),b=e)),null!==b?(t(this,a,b),c(this,"enqueueJob() end: job scheduled",-1)):(l(this,a,d),m(this),c(this,"enqueueJob() end: job pending",-1)))},N:function(a,b){if(this.f){var d=
this.j.getPriority(b);c(this,"jobDone() start: job done of priority "+d,1)}v(this,a);m(this);c(this,"jobDone() end",-1)},O:function(a){c(this,"shouldYieldOrAbort() start",1);a=this.j.getPriority(a);var b;if(!(b=0>a))a:{b=this.a.A();for(c(this,"hasNewJobWithHigherPriority() start",1);null!==b;){var d=this.a.B(b),k=this.a.G(b),h=this.j.getPriority(k.c);if(0>h)q(this,b),--this.i,k.C(k.c);else if(h>a){c(this,"hasNewJobWithHigherPriority() end: returns true",-1);b=!0;break a}b=d}c(this,"hasNewJobWithHigherPriority() end: returns false",
-1);b=!1}a=b;c(this,"shouldYieldOrAbort() end",-1);return a},P:function(a,b,f,h,q){c(this,"tryYield() start",1);var g=this.j.getPriority(b);if(0>g)return f(b),v(this,q),c(this,"tryYield() end: job aborted",-1),!0;var r=d(this,g);m(this);if(null===r)return c(this,"tryYield() end: job continues",-1),!1;h(b);l(this,{H:a,C:f,c:b},g);m(this);t(this,r,q);m(this);c(this,"tryYield() end: job yielded",-1);return!0}};return b}();self.ResourceScheduler={};self.ResourceScheduler.PriorityScheduler=u;self.ResourceScheduler.LifoScheduler=n;u.prototype.shouldYieldOrAbort=u.prototype.O;u.prototype.enqueueJob=u.prototype.M;u.prototype.tryYield=u.prototype.P;u.prototype.jobDone=u.prototype.N;n.prototype.shouldYieldOrAbort=u.prototype.O;n.prototype.enqueueJob=n.prototype.M;n.prototype.tryYield=n.prototype.P;n.prototype.jobDone=n.prototype.N;
