var t=function(){function b(d,h){this.O=d;this.g=this.w=h;this.s=Array(this.w);this.N=[]}function d(d,h){this.i=d;this.v=h}b.prototype.R=function(d,h){if(0<this.g){--this.g;var b=this.s.pop();void 0===b&&(b=this.O());this.U(d,b,h)}else this.N.push({K:d,c:h})};b.prototype.U=function(b,h,q){b(h,q,new d(this,h))};d.prototype.jobDone=function(){if(0<this.i.N.length){var d=this.i.N.pop();this.i.U(d.K,this.v,d.c)}else this.i.s.push(this.v),++this.i.g};d.prototype.shouldYieldOrAbort=function(){return!1};
d.prototype.tryYield=function(){return!1};return b}();var u=function(){function b(){this.H={h:null,I:this};this.A={o:null,I:this};this.m=0;this.A.h=this.H;this.H.o=this.A}b.prototype.add=function(d,b){if(null===b||void 0===b)b=this.A;this.B(b);++this.m;var h={Y:d,o:b,h:b.h,I:this};h.h.o=h;return b.h=h};b.prototype.remove=function(d){this.B(d);--this.m;d.h.o=d.o;d.o.h=d.h;d.I=null};b.prototype.J=function(d){this.B(d);return d.Y};b.prototype.C=function(){return this.D(this.H)};b.prototype.Z=function(){return this.$(this.A)};b.prototype.D=function(d){this.B(d);
return d.o===this.A?null:d.o};b.prototype.$=function(d){this.B(d);return d.h===this.H?null:d.h};b.prototype.B=function(d){if(d.I!==this)throw"iterator must be of the current LinkedList";};return b}();var w=function(){function b(a,g,c,e){e=e||{};this.O=a;this.w=g;this.l=c;this.f=e.showLog;this.V=e.schedulerName;this.M=e.numNewJobs||20;this.W=e.numJobsBeforeRerankOldPriorities||20;this.g=this.w;this.s=Array(this.w);this.X=e.resourcesGuaranteedForHighPriority||0;this.u=">";this.j=0;this.b=[];this.a=new u;this.P=0}function d(a,g){f(a,"tryDequeueNewJobWithHigherPriority() start",1);for(var c=null,e=g,d=[],k=a.a.C();null!==k;){var b=a.a.D(k),h=a.a.J(k),l=a.l.getPriority(h.c);if(0>l)n(a,k),--a.j,h.F(h.c);
else{if(void 0===e||l>e)e=l,c=k;a.f&&(void 0===d[l]?d[l]=1:++d[l])}k=b}k=null;null!==c&&(k=n(a,c),--a.j);if(a.f){c="tryDequeueNewJobWithHigherPriority(): Jobs list:";for(b=0;b<d.length;++b)void 0!==d[b]&&(c+=d[b]+" jobs of priority "+b+";");f(a,c);null!==k&&f(a,"tryDequeueNewJobWithHigherPriority(): dequeued new job of priority "+e)}m(a);f(a,"tryDequeueNewJobWithHigherPriority() end",-1);return k}function v(a,g,c){f(a,"enqueueNewJob() start",1);++a.j;var e=a.a.C();x(a,g,e);a.f&&f(a,"enqueueNewJob(): enqueued job of priority "+
c);a.a.m<=a.M?(m(a),f(a,"enqueueNewJob() end: _newPendingJobsLinkedList is small enough",-1)):(g=a.a.Z(),g=n(a,g),h(a,g),m(a),f(a,"enqueueNewJob() end: One job moved from new job list to old job list",-1))}function h(a,g){f(a,"enqueueOldJob() start",1);var c=a.l.getPriority(g.c);0>c?(--a.j,g.F(g.c),f(a,"enqueueOldJob() end: job aborted",-1)):(void 0===a.b[c]&&(a.b[c]=[]),a.b[c].push(g),f(a,"enqueueOldJob() end: job enqueued to old job list",-1))}function q(a,g){f(a,"resourceFreed() start",1);++a.g;
var c=y(a);--a.g;c=d(a,c);if(null!==c)m(a),r(a,c,g),m(a),f(a,"resourceFreed() end: new job scheduled",-1);else if(a.j>a.a.m){for(var e,b=a.b.length-1;0<=b;--b){var k=a.b[b];if(void 0!==k&&0!==k.length){for(var h=k.length-1;0<=h;--h){c=k[h];e=a.l.getPriority(c.c);if(e>=b){k.length=h;break}else 0>e?(--a.j,c.F(c.c)):(void 0===a.b[e]&&(a.b[e]=[]),a.b[e].push(c));c=null}if(null!==c)break;k.length=0}}null===c?(a.s.push(g),++a.g,m(a),f(a,"resourceFreed() end: no non-aborted job to schedule",-1)):(a.f&&f(a,
"resourceFreed(): dequeued old job of priority "+e),--a.j,m(a),r(a,c,g),m(a),f(a,"resourceFreed() end: job scheduled",-1))}else a.s.push(g),++a.g,m(a),f(a,"resourceFreed() end: no job to schedule",-1)}function r(a,g,c){f(a,"schedule() start",1);++a.P;if(a.P>=a.W){a.P=0;f(a,"rerankPriorities() start",1);var e=a.b,d=a.a;if(0===e.length)f(a,"rerankPriorities() end: no need to rerank",-1);else{a.b=[];a.a=new u;for(var b=0;b<e.length;++b)if(void 0!==e[b])for(var p=0;p<e[b].length;++p)h(a,e[b][p]);for(b=
d.C();null!==b;)e=d.J(b),h(a,e),b=d.D(b);d="rerankPriorities(): ";for(b=a.b.length-1;0<=b;--b)if(e=a.b[b],void 0!==e){for(a.f&&(d+=e.length+" jobs in priority "+b+";");0<e.length&&a.a.m<a.M;)p=e.pop(),x(a,p);if(a.a.m>=a.M&&!a.f)break}a.f&&f(a,d);m(a);f(a,"rerankPriorities() end: rerank done",-1)}}a.f&&(b=a.l.getPriority(g.c),f(a,"schedule(): scheduled job of priority "+b));g.K(c,g.c,new l(a,c,g.c));f(a,"schedule() end",-1)}function x(a,g,c){f(a,"addJobToLinkedList() start",1);a.a.add(g,c);z(a);f(a,
"addJobToLinkedList() end",-1)}function n(a,g){f(a,"extractJobFromLinkedList() start",1);var c=a.a.J(g);a.a.remove(g);z(a);f(a,"extractJobFromLinkedList() end",-1);return c}function z(a){if(a.f){f(a,"ensureNumberOfNodes() start",1);for(var g=a.a.C(),c=0;null!==g;)++c,g=a.a.D(g);if(c!==a.a.m)throw"Unexpected count of new jobs";f(a,"ensureNumberOfNodes() end",-1)}}function m(a){if(a.f){f(a,"ensurePendingJobsCount() start",1);for(var g=0,c=0;c<a.b.length;++c){var b=a.b[c];void 0!==b&&(g+=b.length)}if(g+
a.a.m!==a.j)throw"Unexpected count of jobs";f(a,"ensurePendingJobsCount() end",-1)}}function y(a){f(a,"getMinimalPriorityToSchedule() start",1);if(a.g<=a.X)return f(a,"getMinimalPriorityToSchedule() end: guarantee resource for high priority is needed",-1),a.aa;f(a,"getMinimalPriorityToSchedule() end: enough resources, no need to guarantee resource for high priority",-1);return 0}function f(a,b,c){a.f&&(-1===c&&(a.u=a.u.substr(1)),void 0!==a.V?console.log(a.u+"PriorityScheduler "+a.V+": "+b):console.log(a.u+
"PriorityScheduler: "+b),1===c&&(a.u+=">"))}function l(a,b,c){this.T=!0;this.i=a;this.v=b;this.G=c}b.prototype.R=function(a,b,c){f(this,"enqueueJob() start",1);var e=this.l.getPriority(b);0>e?(c(b),f(this,"enqueueJob() end: job aborted",-1)):(a={K:a,F:c,c:b},b=y(this),c=null,e>=b&&(f(this,"tryGetFreeResource() start",1),0===this.g?c=null:(--this.g,b=this.s.pop(),void 0===b&&(b=this.O()),m(this),f(this,"tryGetFreeResource() end",-1),c=b)),null!==c?(r(this,a,c),f(this,"enqueueJob() end: job scheduled",
-1)):(v(this,a,e),m(this),f(this,"enqueueJob() end: job pending",-1)))};l.prototype.L=function(){if(!this.T)throw"ResourceScheduler error: Already terminated job";};l.prototype.S=function(){this.T=!1;this.i=this.G=this.v=null};l.prototype.jobDone=function(){this.L();var a=this.i,b=this.v;if(a.f){var c=a.l.getPriority(this.G);f(a,"jobDone() start: job done of priority "+c,1)}q(a,b);m(a);f(a,"jobDone() end",-1);this.S()};l.prototype.shouldYieldOrAbort=function(){this.L();var a=this.i,b=this.G;f(a,"shouldYieldOrAbort() start",
1);var b=a.l.getPriority(b),c;if(!(c=0>b))a:{c=a.a.C();for(f(a,"hasNewJobWithHigherPriority() start",1);null!==c;){var e=a.a.D(c),d=a.a.J(c),h=a.l.getPriority(d.c);if(0>h)n(a,c),--a.j,d.F(d.c);else if(h>b){f(a,"hasNewJobWithHigherPriority() end: returns true",-1);c=!0;break a}c=e}f(a,"hasNewJobWithHigherPriority() end: returns false",-1);c=!1}b=c;f(a,"shouldYieldOrAbort() end",-1);return b};l.prototype.tryYield=function(a,b,c){this.L();var e=this.i,h=this.G,k=this.v;f(e,"tryYield() start",1);var l=
e.l.getPriority(h);if(0>l)b(h),q(e,k),f(e,"tryYield() end: job aborted",-1),a=!0;else{var n=d(e,l);m(e);null===n?(f(e,"tryYield() end: job continues",-1),a=!1):(c(h),v(e,{K:a,F:b,c:h},l),m(e),r(e,n,k),m(e),f(e,"tryYield() end: job yielded",-1),a=!0)}a&&this.S();return a};return b}();self.ResourceScheduler={};self.ResourceScheduler.PriorityScheduler=w;self.ResourceScheduler.LifoScheduler=t;w.prototype.enqueueJob=w.prototype.R;t.prototype.enqueueJob=t.prototype.R;
