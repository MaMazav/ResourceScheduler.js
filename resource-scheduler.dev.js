var r=function(){function d(b,d){this.O=b;this.g=this.w=d;this.s=Array(this.w);this.N=[]}function b(b,d){this.i=b;this.v=d}d.prototype.R=function(b,d){if(0<this.g){--this.g;var g=this.s.pop();void 0===g&&(g=this.O());this.U(b,g,d)}else this.N.push({K:b,c:d})};d.prototype.U=function(d,l,g){d(l,g,new b(this,l))};b.prototype.jobDone=function(){if(0<this.i.N.length){var b=this.i.N.pop();this.i.U(b.K,this.v,b.c)}else this.i.s.push(this.v),++this.i.g};b.prototype.shouldYieldOrAbort=function(){return!1};
b.prototype.tryYield=function(){return!1};return d}();var t=function(){function d(){this.clear()}d.prototype.clear=function(){this.H={h:null,I:this};this.A={o:null,I:this};this.m=0;this.A.h=this.H;this.H.o=this.A};d.prototype.add=function(b,d){if(null===d||void 0===d)d=this.A;this.B(d);++this.m;var l={Y:b,o:d,h:d.h,I:this};l.h.o=l;return d.h=l};d.prototype.remove=function(b){this.B(b);--this.m;b.h.o=b.o;b.o.h=b.h;b.I=null};d.prototype.J=function(b){this.B(b);return b.Y};d.prototype.C=function(){return this.D(this.H)};d.prototype.Z=function(){return this.$(this.A)};
d.prototype.D=function(b){this.B(b);return b.o===this.A?null:b.o};d.prototype.$=function(b){this.B(b);return b.h===this.H?null:b.h};d.prototype.B=function(b){if(b.I!==this)throw"iterator must be of the current LinkedList";};return d}();var v=function(){function d(a,h,c,e){e=e||{};this.O=a;this.w=h;this.l=c;this.f=e.showLog;this.V=e.schedulerName;this.M=e.numNewJobs||20;this.W=e.numJobsBeforeRerankOldPriorities||20;this.g=this.w;this.s=Array(this.w);this.X=e.resourcesGuaranteedForHighPriority||0;this.u=">";this.j=0;this.b=[];this.a=new t;this.P=0}function b(a,h){f(a,"tryDequeueNewJobWithHigherPriority() start",1);for(var c=null,e=h,b=[],k=a.a.C();null!==k;){var d=a.a.D(k),l=a.a.J(k),g=a.l.getPriority(l.c);if(0>g)p(a,k),--a.j,l.F(l.c);
else{if(void 0===e||g>e)e=g,c=k;a.f&&(void 0===b[g]?b[g]=1:++b[g])}k=d}k=null;null!==c&&(k=p(a,c),--a.j);if(a.f){c="tryDequeueNewJobWithHigherPriority(): Jobs list:";for(d=0;d<b.length;++d)void 0!==b[d]&&(c+=b[d]+" jobs of priority "+d+";");f(a,c);null!==k&&f(a,"tryDequeueNewJobWithHigherPriority(): dequeued new job of priority "+e)}m(a);f(a,"tryDequeueNewJobWithHigherPriority() end",-1);return k}function u(a,h,c){f(a,"enqueueNewJob() start",1);++a.j;var e=a.a.C();w(a,h,e);a.f&&f(a,"enqueueNewJob(): enqueued job of priority "+
c);a.a.m<=a.M?(m(a),f(a,"enqueueNewJob() end: _newPendingJobsLinkedList is small enough",-1)):(h=a.a.Z(),h=p(a,h),l(a,h),m(a),f(a,"enqueueNewJob() end: One job moved from new job list to old job list",-1))}function l(a,h){f(a,"enqueueOldJob() start",1);var c=a.l.getPriority(h.c);0>c?(--a.j,h.F(h.c),f(a,"enqueueOldJob() end: job aborted",-1)):(void 0===a.b[c]&&(a.b[c]=[]),a.b[c].push(h),f(a,"enqueueOldJob() end: job enqueued to old job list",-1))}function g(a,h){f(a,"resourceFreed() start",1);++a.g;
var c=x(a);--a.g;c=b(a,c);if(null!==c)m(a),q(a,c,h),m(a),f(a,"resourceFreed() end: new job scheduled",-1);else if(a.j>a.a.m){for(var e,d=a.b.length-1;0<=d;--d){var k=a.b[d];if(void 0!==k&&0!==k.length){for(var g=k.length-1;0<=g;--g){c=k[g];e=a.l.getPriority(c.c);if(e>=d){k.length=g;break}else 0>e?(--a.j,c.F(c.c)):(void 0===a.b[e]&&(a.b[e]=[]),a.b[e].push(c));c=null}if(null!==c)break;k.length=0}}null===c?(a.s.push(h),++a.g,m(a),f(a,"resourceFreed() end: no non-aborted job to schedule",-1)):(a.f&&f(a,
"resourceFreed(): dequeued old job of priority "+e),--a.j,m(a),q(a,c,h),m(a),f(a,"resourceFreed() end: job scheduled",-1))}else a.s.push(h),++a.g,m(a),f(a,"resourceFreed() end: no job to schedule",-1)}function q(a,h,c){f(a,"schedule() start",1);++a.P;if(a.P>=a.W){a.P=0;f(a,"rerankPriorities() start",1);var e=a.b,d=a.a;if(0===e.length)f(a,"rerankPriorities() end: no need to rerank",-1);else{a.b=[];a.a=new t;for(var b=0;b<e.length;++b)if(void 0!==e[b])for(var g=0;g<e[b].length;++g)l(a,e[b][g]);for(b=
d.C();null!==b;)e=d.J(b),l(a,e),b=d.D(b);d="rerankPriorities(): ";for(b=a.b.length-1;0<=b;--b)if(e=a.b[b],void 0!==e){for(a.f&&(d+=e.length+" jobs in priority "+b+";");0<e.length&&a.a.m<a.M;)g=e.pop(),w(a,g);if(a.a.m>=a.M&&!a.f)break}a.f&&f(a,d);m(a);f(a,"rerankPriorities() end: rerank done",-1)}}a.f&&(b=a.l.getPriority(h.c),f(a,"schedule(): scheduled job of priority "+b));h.K(c,h.c,new n(a,c,h.c));f(a,"schedule() end",-1)}function w(a,b,c){f(a,"addJobToLinkedList() start",1);a.a.add(b,c);y(a);f(a,
"addJobToLinkedList() end",-1)}function p(a,b){f(a,"extractJobFromLinkedList() start",1);var c=a.a.J(b);a.a.remove(b);y(a);f(a,"extractJobFromLinkedList() end",-1);return c}function y(a){if(a.f){f(a,"ensureNumberOfNodes() start",1);for(var b=a.a.C(),c=0;null!==b;)++c,b=a.a.D(b);if(c!==a.a.m)throw"Unexpected count of new jobs";f(a,"ensureNumberOfNodes() end",-1)}}function m(a){if(a.f){f(a,"ensurePendingJobsCount() start",1);for(var b=0,c=0;c<a.b.length;++c){var e=a.b[c];void 0!==e&&(b+=e.length)}if(b+
a.a.m!==a.j)throw"Unexpected count of jobs";f(a,"ensurePendingJobsCount() end",-1)}}function x(a){f(a,"getMinimalPriorityToSchedule() start",1);if(a.g<=a.X)return f(a,"getMinimalPriorityToSchedule() end: guarantee resource for high priority is needed",-1),a.aa;f(a,"getMinimalPriorityToSchedule() end: enough resources, no need to guarantee resource for high priority",-1);return 0}function f(a,b,c){a.f&&(-1===c&&(a.u=a.u.substr(1)),void 0!==a.V?console.log(a.u+"PriorityScheduler "+a.V+": "+b):console.log(a.u+
"PriorityScheduler: "+b),1===c&&(a.u+=">"))}function n(a,b,c){this.T=!0;this.i=a;this.v=b;this.G=c}d.prototype.R=function(a,b,c){f(this,"enqueueJob() start",1);var e=this.l.getPriority(b);0>e?(c(b),f(this,"enqueueJob() end: job aborted",-1)):(a={K:a,F:c,c:b},b=x(this),c=null,e>=b&&(f(this,"tryGetFreeResource() start",1),0===this.g?c=null:(--this.g,b=this.s.pop(),void 0===b&&(b=this.O()),m(this),f(this,"tryGetFreeResource() end",-1),c=b)),null!==c?(q(this,a,c),f(this,"enqueueJob() end: job scheduled",
-1)):(u(this,a,e),m(this),f(this,"enqueueJob() end: job pending",-1)))};n.prototype.L=function(){if(!this.T)throw"ResourceScheduler error: Already terminated job";};n.prototype.S=function(){this.T=!1;this.i=this.G=this.v=null};n.prototype.jobDone=function(){this.L();var a=this.i,b=this.v;if(a.f){var c=a.l.getPriority(this.G);f(a,"jobDone() start: job done of priority "+c,1)}g(a,b);m(a);f(a,"jobDone() end",-1);this.S()};n.prototype.shouldYieldOrAbort=function(){this.L();var a=this.i,b=this.G;f(a,"shouldYieldOrAbort() start",
1);var b=a.l.getPriority(b),c;if(!(c=0>b))a:{c=a.a.C();for(f(a,"hasNewJobWithHigherPriority() start",1);null!==c;){var e=a.a.D(c),d=a.a.J(c),g=a.l.getPriority(d.c);if(0>g)p(a,c),--a.j,d.F(d.c);else if(g>b){f(a,"hasNewJobWithHigherPriority() end: returns true",-1);c=!0;break a}c=e}f(a,"hasNewJobWithHigherPriority() end: returns false",-1);c=!1}b=c;f(a,"shouldYieldOrAbort() end",-1);return b};n.prototype.tryYield=function(a,d,c){this.L();var e=this.i,l=this.G,k=this.v;f(e,"tryYield() start",1);var n=
e.l.getPriority(l);if(0>n)d(l),g(e,k),f(e,"tryYield() end: job aborted",-1),a=!0;else{var p=b(e,n);m(e);null===p?(f(e,"tryYield() end: job continues",-1),a=!1):(c(l),u(e,{K:a,F:d,c:l},n),m(e),q(e,p,k),m(e),f(e,"tryYield() end: job yielded",-1),a=!0)}a&&this.S();return a};return d}();self.ResourceScheduler={};self.ResourceScheduler.PriorityScheduler=v;self.ResourceScheduler.LifoScheduler=r;v.prototype.enqueueJob=v.prototype.R;r.prototype.enqueueJob=r.prototype.R;
